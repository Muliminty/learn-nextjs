# 客户端组件实践

## 3.1 回顾：客户端组件基础

客户端组件使用 `'use client'` 指令，在浏览器中运行，支持交互性和 React Hooks。

### 客户端组件的特点

**✅ 优势：**
- 可以使用 React Hooks（`useState`、`useEffect` 等）
- 可以使用事件处理器（`onClick`、`onChange` 等）
- 可以访问浏览器 API（`localStorage`、`window` 等）
- 支持用户交互

**❌ 限制：**
- 增加客户端 JavaScript 体积
- 不能直接访问数据库或文件系统
- 代码会发送到客户端，敏感信息可能暴露

---

## 3.2 使用 React Hooks

### Hook 1：useState

`useState` 用于管理组件的状态。

**基本用法：**

```typescript
'use client'

import { useState } from 'react'

export default function Counter() {
  const [count, setCount] = useState(0)
  
  return (
    <div>
      <p>计数: {count}</p>
      <button onClick={() => setCount(count + 1)}>增加</button>
      <button onClick={() => setCount(count - 1)}>减少</button>
      <button onClick={() => setCount(0)}>重置</button>
    </div>
  )
}
```

**使用函数式更新：**

```typescript
'use client'

import { useState } from 'react'

export default function Counter() {
  const [count, setCount] = useState(0)
  
  const increment = () => {
    setCount((prevCount) => prevCount + 1) // 使用函数式更新
  }
  
  return (
    <div>
      <p>计数: {count}</p>
      <button onClick={increment}>增加</button>
    </div>
  )
}
```

**多个状态：**

```typescript
'use client'

import { useState } from 'react'

export default function Form() {
  const [name, setName] = useState('')
  const [email, setEmail] = useState('')
  const [age, setAge] = useState(0)
  
  return (
    <form>
      <input
        type="text"
        placeholder="姓名"
        value={name}
        onChange={(e) => setName(e.target.value)}
      />
      <input
        type="email"
        placeholder="邮箱"
        value={email}
        onChange={(e) => setEmail(e.target.value)}
      />
      <input
        type="number"
        placeholder="年龄"
        value={age}
        onChange={(e) => setAge(Number(e.target.value))}
      />
    </form>
  )
}
```

---

### Hook 2：useEffect

`useEffect` 用于处理副作用，如数据获取、订阅、DOM 操作等。

**基本用法：**

```typescript
'use client'

import { useState, useEffect } from 'react'

export default function Timer() {
  const [seconds, setSeconds] = useState(0)
  
  useEffect(() => {
    const interval = setInterval(() => {
      setSeconds((prev) => prev + 1)
    }, 1000)
    
    // 清理函数：组件卸载时清除定时器
    return () => clearInterval(interval)
  }, []) // 空依赖数组：只在组件挂载时执行一次
  
  return <div>计时: {seconds} 秒</div>
}
```

**依赖数组：**

```typescript
'use client'

import { useState, useEffect } from 'react'

export default function UserProfile({ userId }: { userId: string }) {
  const [user, setUser] = useState(null)
  
  useEffect(() => {
    // 当 userId 改变时，重新获取用户数据
    fetch(`/api/users/${userId}`)
      .then((res) => res.json())
      .then((data) => setUser(data))
  }, [userId]) // 依赖 userId：当 userId 改变时执行
  
  if (!user) return <div>加载中...</div>
  
  return <div>{user.name}</div>
}
```

**清理副作用：**

```typescript
'use client'

import { useState, useEffect } from 'react'

export default function WindowSize() {
  const [width, setWidth] = useState(0)
  const [height, setHeight] = useState(0)
  
  useEffect(() => {
    const handleResize = () => {
      setWidth(window.innerWidth)
      setHeight(window.innerHeight)
    }
    
    // 添加事件监听器
    window.addEventListener('resize', handleResize)
    
    // 初始化
    handleResize()
    
    // 清理函数：移除事件监听器
    return () => {
      window.removeEventListener('resize', handleResize)
    }
  }, []) // 空依赖数组：只在挂载时添加监听器
  
  return (
    <div>
      <p>窗口宽度: {width}px</p>
      <p>窗口高度: {height}px</p>
    </div>
  )
}
```

---

## 3.3 创建交互式组件

### 组件 1：计数器

**创建组件：** `app/components/Counter.tsx`

```typescript
'use client'

import { useState } from 'react'
import Button from '@/app/components/ui/Button'

interface CounterProps {
  initialValue?: number
  step?: number
}

export default function Counter({ initialValue = 0, step = 1 }: CounterProps) {
  const [count, setCount] = useState(initialValue)
  
  const increment = () => setCount((prev) => prev + step)
  const decrement = () => setCount((prev) => prev - step)
  const reset = () => setCount(initialValue)
  
  return (
    <div className="flex items-center gap-4">
      <Button variant="secondary" onClick={decrement}>
        -
      </Button>
      <span className="text-2xl font-bold w-16 text-center">{count}</span>
      <Button variant="primary" onClick={increment}>
        +
      </Button>
      <Button variant="secondary" onClick={reset}>
        重置
      </Button>
    </div>
  )
}
```

**使用示例：**

```typescript
import Counter from '@/app/components/Counter'

export default function Page() {
  return (
    <div>
      <Counter initialValue={10} step={5} />
    </div>
  )
}
```

---

### 组件 2：表单

**创建组件：** `app/components/ContactForm.tsx`

```typescript
'use client'

import { useState } from 'react'
import Input from '@/app/components/ui/Input'
import Button from '@/app/components/ui/Button'
import Card from '@/app/components/ui/Card'

export default function ContactForm() {
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    message: '',
  })
  
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [submitStatus, setSubmitStatus] = useState<'idle' | 'success' | 'error'>('idle')
  
  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target
    setFormData((prev) => ({
      ...prev,
      [name]: value,
    }))
  }
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsSubmitting(true)
    setSubmitStatus('idle')
    
    try {
      // 模拟 API 调用
      await new Promise((resolve) => setTimeout(resolve, 1000))
      
      console.log('提交数据:', formData)
      setSubmitStatus('success')
      setFormData({ name: '', email: '', message: '' })
    } catch (error) {
      setSubmitStatus('error')
    } finally {
      setIsSubmitting(false)
    }
  }
  
  return (
    <Card title="联系我们">
      <form onSubmit={handleSubmit} className="space-y-4">
        <Input
          label="姓名"
          name="name"
          value={formData.name}
          onChange={handleChange}
          required
        />
        <Input
          label="邮箱"
          type="email"
          name="email"
          value={formData.email}
          onChange={handleChange}
          required
        />
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            留言
          </label>
          <textarea
            name="message"
            value={formData.message}
            onChange={handleChange}
            required
            rows={4}
            className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        
        {submitStatus === 'success' && (
          <div className="p-3 bg-green-100 text-green-700 rounded">
            提交成功！
          </div>
        )}
        
        {submitStatus === 'error' && (
          <div className="p-3 bg-red-100 text-red-700 rounded">
            提交失败，请重试
          </div>
        )}
        
        <Button
          type="submit"
          variant="primary"
          disabled={isSubmitting}
        >
          {isSubmitting ? '提交中...' : '提交'}
        </Button>
      </form>
    </Card>
  )
}
```

---

### 组件 3：搜索框

**创建组件：** `app/components/SearchBox.tsx`

```typescript
'use client'

import { useState, useEffect } from 'react'
import Input from '@/app/components/ui/Input'

interface SearchBoxProps {
  onSearch?: (query: string) => void
  placeholder?: string
  debounceMs?: number
}

export default function SearchBox({
  onSearch,
  placeholder = '搜索...',
  debounceMs = 300,
}: SearchBoxProps) {
  const [query, setQuery] = useState('')
  
  useEffect(() => {
    // 防抖：延迟执行搜索
    const timer = setTimeout(() => {
      if (onSearch) {
        onSearch(query)
      }
    }, debounceMs)
    
    return () => clearTimeout(timer)
  }, [query, onSearch, debounceMs])
  
  return (
    <Input
      type="text"
      placeholder={placeholder}
      value={query}
      onChange={(e) => setQuery(e.target.value)}
    />
  )
}
```

**使用示例：**

```typescript
'use client'

import { useState } from 'react'
import SearchBox from '@/app/components/SearchBox'

export default function SearchPage() {
  const [results, setResults] = useState<string[]>([])
  
  const handleSearch = (query: string) => {
    // 模拟搜索
    const mockResults = query
      ? ['结果1', '结果2', '结果3'].filter((r) => r.includes(query))
      : []
    setResults(mockResults)
  }
  
  return (
    <div>
      <SearchBox onSearch={handleSearch} />
      <ul>
        {results.map((result, index) => (
          <li key={index}>{result}</li>
        ))}
      </ul>
    </div>
  )
}
```

---

## 3.4 实践：创建一个待办事项组件

### 步骤 1：创建待办事项组件

**创建组件：** `app/components/TodoList.tsx`

```typescript
'use client'

import { useState } from 'react'
import Button from '@/app/components/ui/Button'
import Input from '@/app/components/ui/Input'
import Card from '@/app/components/ui/Card'

interface Todo {
  id: number
  text: string
  completed: boolean
}

export default function TodoList() {
  const [todos, setTodos] = useState<Todo[]>([])
  const [inputValue, setInputValue] = useState('')
  const [nextId, setNextId] = useState(1)
  
  const addTodo = () => {
    if (inputValue.trim()) {
      setTodos([
        ...todos,
        {
          id: nextId,
          text: inputValue,
          completed: false,
        },
      ])
      setInputValue('')
      setNextId(nextId + 1)
    }
  }
  
  const toggleTodo = (id: number) => {
    setTodos(
      todos.map((todo) =>
        todo.id === id ? { ...todo, completed: !todo.completed } : todo
      )
    )
  }
  
  const deleteTodo = (id: number) => {
    setTodos(todos.filter((todo) => todo.id !== id))
  }
  
  const completedCount = todos.filter((todo) => todo.completed).length
  const totalCount = todos.length
  
  return (
    <Card title="待办事项">
      <div className="space-y-4">
        {/* 输入区域 */}
        <div className="flex gap-2">
          <Input
            placeholder="添加新待办..."
            value={inputValue}
            onChange={(e) => setInputValue(e.target.value)}
            onKeyPress={(e) => {
              if (e.key === 'Enter') {
                addTodo()
              }
            }}
            className="flex-1"
          />
          <Button variant="primary" onClick={addTodo}>
            添加
          </Button>
        </div>
        
        {/* 统计信息 */}
        <div className="text-sm text-gray-600">
          已完成: {completedCount} / 总计: {totalCount}
        </div>
        
        {/* 待办列表 */}
        <ul className="space-y-2">
          {todos.length === 0 ? (
            <li className="text-gray-500 text-center py-8">
              暂无待办事项，添加一个吧！
            </li>
          ) : (
            todos.map((todo) => (
              <li
                key={todo.id}
                className="flex items-center gap-3 p-3 border rounded hover:bg-gray-50"
              >
                <input
                  type="checkbox"
                  checked={todo.completed}
                  onChange={() => toggleTodo(todo.id)}
                  className="w-5 h-5"
                />
                <span
                  className={`flex-1 ${
                    todo.completed
                      ? 'line-through text-gray-400'
                      : 'text-gray-800'
                  }`}
                >
                  {todo.text}
                </span>
                <Button
                  variant="danger"
                  onClick={() => deleteTodo(todo.id)}
                  className="text-sm"
                >
                  删除
                </Button>
              </li>
            ))
          )}
        </ul>
      </div>
    </Card>
  )
}
```

---

### 步骤 2：创建待办事项页面

**创建页面：** `app/todos/page.tsx`

```typescript
import TodoList from '@/app/components/TodoList'

export default function TodosPage() {
  return (
    <div className="container mx-auto p-8">
      <h1 className="text-3xl font-bold mb-8">我的待办事项</h1>
      <div className="max-w-2xl">
        <TodoList />
      </div>
    </div>
  )
}
```

**访问 URL：** `http://localhost:3000/todos`

---

### 步骤 3：增强功能（可选）

**使用 localStorage 持久化：**

```typescript
'use client'

import { useState, useEffect } from 'react'
// ... 其他导入

export default function TodoList() {
  const [todos, setTodos] = useState<Todo[]>([])
  
  // 从 localStorage 加载数据
  useEffect(() => {
    const savedTodos = localStorage.getItem('todos')
    if (savedTodos) {
      setTodos(JSON.parse(savedTodos))
    }
  }, [])
  
  // 保存数据到 localStorage
  useEffect(() => {
    localStorage.setItem('todos', JSON.stringify(todos))
  }, [todos])
  
  // ... 其他代码
}
```

---

## 3.5 客户端组件最佳实践

### 实践 1：只在需要时使用客户端组件

```typescript
// ✅ 推荐：只在需要交互时使用客户端组件
'use client'
export default function InteractiveButton() {
  const [count, setCount] = useState(0)
  return <button onClick={() => setCount(count + 1)}>{count}</button>
}

// ❌ 不推荐：不需要交互时使用客户端组件
'use client'
export default function StaticText() {
  return <p>这是静态文本</p> // 应该使用服务端组件
}
```

### 实践 2：合理使用 useEffect

```typescript
// ✅ 推荐：正确使用依赖数组
useEffect(() => {
  fetchData(userId)
}, [userId]) // 明确依赖

// ❌ 不推荐：缺少依赖或依赖不正确
useEffect(() => {
  fetchData(userId)
}, []) // 缺少 userId 依赖
```

### 实践 3：清理副作用

```typescript
// ✅ 推荐：清理副作用
useEffect(() => {
  const timer = setInterval(() => {
    // ...
  }, 1000)
  
  return () => clearInterval(timer) // 清理
}, [])

// ❌ 不推荐：不清理副作用
useEffect(() => {
  const timer = setInterval(() => {
    // ...
  }, 1000)
  // 缺少清理函数，可能导致内存泄漏
}, [])
```

---

## 3.6 常见问题解答

### Q1：什么时候应该使用客户端组件？

**A：** 当需要以下功能时：
- 用户交互（点击、输入等）
- React Hooks（useState、useEffect 等）
- 浏览器 API（localStorage、window 等）
- 事件处理器（onClick、onChange 等）

### Q2：客户端组件可以调用 API 吗？

**A：** 可以，但通常不推荐。更好的做法是：
- 在服务端组件中获取数据
- 通过 props 传递给客户端组件
- 或者使用 Server Actions（后续学习）

### Q3：如何优化客户端组件的性能？

**A：** 
- 使用 `useMemo` 缓存计算结果
- 使用 `useCallback` 缓存函数
- 使用 `React.memo` 避免不必要的重渲染
- 合理使用 `useEffect` 的依赖数组

---

## 3.7 总结

### 关键要点

1. **使用 `'use client'`**：在文件顶部添加指令创建客户端组件
2. **React Hooks**：使用 `useState` 管理状态，`useEffect` 处理副作用
3. **交互式组件**：创建表单、计数器、搜索框等交互组件
4. **实践项目**：创建待办事项组件，综合运用所学知识

### 下一步

完成客户端组件实践后，可以学习组件组合模式，了解如何通过 props 和 children 实现组件的灵活组合。

---

**学习进度：** ✅ 客户端组件实践完成

